@component-name = "portal-database-upgrade-framework"
definition {

	property app.server.types = "tomcat";
	property ci.retries.disabled = "true";
	property database.types = "mysql";
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.main.component.name = "Database Upgrade Framework";

	@ignore = "true"
	@priority = 4
	test ComparePartitionedUpgradedAndFreshDBSchemas7413 {
		property data.archive.type = "data-archive-portal-partition";
		property database.partition.enabled = "true";
		property liferay.online.properties = "true";
		property portal.smoke.upgrades = "true";
		property portal.version = "7.4.13.u33";

		task ("Given the user have a partitioned upgraded base And export the schemas") {
			Portlet.shutdownServer();

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lpartition_44913");

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lpartition_42638");
		}

		task ("When the user rebuild the database And clean the missing partitions") {
			AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

			SQL.executeMySQLStatement(mysqlStatement = "DROP DATABASE lpartition_42638;");

			SQL.executeMySQLStatement(mysqlStatement = "DROP DATABASE lpartition_44913;");
		}

		task ("And the user start the server again to have a fresh and clean base") {
			Portlet.startServer();

			User.firstLoginPG(
				password = "test",
				userEmailAddress = "test@liferay.com",
				virtualHostsURL = "http://localhost:8080");
		}

		task ("And the user add two new partitions to emulate the same enviroment as before") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");

			User.firstLoginPG(
				password = "test",
				userEmailAddress = "test@www.able.com",
				virtualHostsURL = "http://www.able.com:8080");
		}

		task ("Then he export the fresh schemas") {
			var companyId1 = JSONCompany.getCompanyId(portalInstanceName = "www.able.com");
			var companyId2 = JSONCompany.getCompanyId(portalInstanceName = "www.baker.com");

			Portlet.shutdownServer();

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lpartition_${companyId1}");

			AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lpartition_${companyId2}");
		}

		task ("And validate that the schemas structure is the same between upgraded and fresh bases") {
			UpgradeSchema.validateSchemas(
				freshDBSchemaName = "lpartition_${companyId1}",
				upgradedDBSchemaName = "lpartition_44913");

			UpgradeSchema.validateSchemas(
				freshDBSchemaName = "lpartition_${companyId2}",
				upgradedDBSchemaName = "lpartition_42638");

			UpgradeSchema.validateSchemas(
				freshDBSchemaName = "lportal",
				upgradedDBSchemaName = "lportal");
		}
	}

	@ignore = "true"
	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas6130 {
		property custom.properties = "feature.flag.LPS-157670=true";
		property data.archive.type = "data-archive-portal";
		property portal.version = "6.1.30";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@ignore = "true"
	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas7210 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "7.2.10";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas7310 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "7.3.10";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas7413 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "7.4.13";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@ignore = "true"
	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas70106 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "7.0.10.6";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@ignore = "true"
	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas71103 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "7.1.10.3";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@ignore = "true"
	@priority = 4
	test CompareUpgradedAndFreshDatabaseSchemas621021 {
		property data.archive.type = "data-archive-portal";
		property portal.version = "6.2.10.21";

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.type=mysql -Dsql.dir=sql/create-bare/ -Dsql.file=create-bare-mysql.sql");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

}